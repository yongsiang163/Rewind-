<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Rewind</title>
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAIAAACyr5FlAAAFZ0lEQVR4nO3dTW7cRhBAYToIYAg2fDwtdBlBl9HC5zMQZJdFAwQzMzViN6vrr9+3jmVN8aWaQwmeb79+vGzAI395fwOIizggIg6IiAMi4oCIOCAiDoiIAyLigIg4ICIOiIgDIuKA6G/vb8DBz5fvA3/qzz//qn8nwdWPYyyFM1+nfC4149AK4vzfUjKUOnHYBHHmby8TSvo4fJt4aP+WsleSOI6AWdxo32HeRPLFEb+JG3kXSaY40mVxI90iyRFH9iyOEiUSPY5KWRylSCT04/OqZeyCv8CgmyP41BRFXiHh4lgni6OYicQ6VtYsYxft5QeKI9poXIQaQohjJdRE3MU5Yvw3B2U8FGEsznFEGEFY7sNxO1bcX3kKvkeMz+agjC5e43KIgzIGuAzNOg7KGGY/OtM4KOMi4wHaxUEZKizHaBQHZSgyG6ZFHJShzmak0+OgjEkMBuv/+BxhzY2DtTHV7PFOjIMyDEwd8qw4KMPMvFFzzwHRlDhYG8YmDVw/DspwMWPsynFQhiP14XPPAZHmb4K5r43fH28n/8vX98/hr9z7Zy39fPmu+GtjIX77PJc9lMiVqFA7VtzXhr3zi8qS4oXQiWPBMprfH28BE9G6HNyQKgjYhwqFOJZdG0fR+lC5KGwONdH6uO5qHKyNo1B9XL80bA6ILsXB2rhXaXmwOSAiDn2hlscV44/PVz5T9gfn8Tu48tMWNsclr++fD3/CEj+aMwbjWHlt3Av+E7jhi8Xm0BG8jzHEAdFIHJwpD90sj1C3HWOXjM0BEXFoKnbnQRwQdcfBDUdSAxeOzQERcUBEHBD1xcENx3Ohnm3c6718bA6IiEPNzdoo8MyDOCAiDh3B7zbGEIeCkmVsXb8myFuVe1IWYW84un5rkH+CYUTVVXGDY0Vf2LXRizggIg5lZdbGRhx4gjg0VVobG3EoKlbGRhxa6pWxEccZXz7VKFnGxkOw55bNomFziBZ5DPoEcTxw/l8XrR0QcTxQ+7A4jziuKrw8iOOxruVRtQ/iEHG4EIeOksujIw7FT3nJot7h0nUR2RwQEccX6i2P84jja8v2QRwQEccpay6PvjgWfMOyK9BH7+Vjc0BEHB0KLI8uxNFnqWfq3XGsfNvRK9TyGLhwbI5u6xwuxDFikcOFOKbLuzxG4uC2Y8t2uIxdMjYHRMQxLtfyGDAYBydLk6IPPh0S+sbjYHk0wZfHlcvE5lAQvI9hxAHRpTg4WXYxl8fFC8TmUFPvmfrVOFgeYwyWx/VLw+bQFPNwGaYQB8vjKMjhonJR2Byegi8PnThYHkcnl8fr++ekNaN1OdQ2B310mXf6KF4IjpUpnlz7eQtD3bdfP14Uvxwf2HNk/5GAuvubzWEky7Y4Ut4cG8vj/35/vJlloX7bpx/HRh8eZrwhmHKs8M7F2KSBc88B0aw4WB5m5o164uagDwNThzz3WKGPqWaPl3sOiKbHwfKYxGCwFpuDPtTZjNToWKEPRWbDtLvnoA8VlmM0vSGlj4uMB2j9boU+htmPzuGtLH0McBmaz3MO+ujiNS63Dx1uL5gf7j/n+3+R8xNSVsgT7sPxf3zuPoKYIowlxGfZc8QcRcii8d8cuzhDcRRqCIHi2IKNxl60lx/iWDla84iJlkUTLo5mnURiZtHEOlZuRB6ciuAvMOjm2FVdIcGzaKLH0VRKJEUWTY44muyJJMqiyRRHs484SyXpmtjli2MXf5HkzaJJHEcTcJFkb2KXPo7d8ZLYh1ImiKM6cRzZhFIyiKOacRzdX8KxXMqncK9+HPcWvMxjQj8+hy/igIg4ICIOiIgDIuKAiDggIg6IiAMi4oCIOCAiDoiIA6L/ANM3zXjR+SvfAAAAAElFTkSuQmCC">
<link rel="apple-touch-icon-precomposed" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAIAAACyr5FlAAAFZ0lEQVR4nO3dTW7cRhBAYToIYAg2fDwtdBlBl9HC5zMQZJdFAwQzMzViN6vrr9+3jmVN8aWaQwmeb79+vGzAI395fwOIizggIg6IiAMi4oCIOCAiDoiIAyLigIg4ICIOiIgDIuKA6G/vb8DBz5fvA3/qzz//qn8nwdWPYyyFM1+nfC4149AK4vzfUjKUOnHYBHHmby8TSvo4fJt4aP+WsleSOI6AWdxo32HeRPLFEb+JG3kXSaY40mVxI90iyRFH9iyOEiUSPY5KWRylSCT04/OqZeyCv8CgmyP41BRFXiHh4lgni6OYicQ6VtYsYxft5QeKI9poXIQaQohjJdRE3MU5Yvw3B2U8FGEsznFEGEFY7sNxO1bcX3kKvkeMz+agjC5e43KIgzIGuAzNOg7KGGY/OtM4KOMi4wHaxUEZKizHaBQHZSgyG6ZFHJShzmak0+OgjEkMBuv/+BxhzY2DtTHV7PFOjIMyDEwd8qw4KMPMvFFzzwHRlDhYG8YmDVw/DspwMWPsynFQhiP14XPPAZHmb4K5r43fH28n/8vX98/hr9z7Zy39fPmu+GtjIX77PJc9lMiVqFA7VtzXhr3zi8qS4oXQiWPBMprfH28BE9G6HNyQKgjYhwqFOJZdG0fR+lC5KGwONdH6uO5qHKyNo1B9XL80bA6ILsXB2rhXaXmwOSAiDn2hlscV44/PVz5T9gfn8Tu48tMWNsclr++fD3/CEj+aMwbjWHlt3Av+E7jhi8Xm0BG8jzHEAdFIHJwpD90sj1C3HWOXjM0BEXFoKnbnQRwQdcfBDUdSAxeOzQERcUBEHBD1xcENx3Ohnm3c6718bA6IiEPNzdoo8MyDOCAiDh3B7zbGEIeCkmVsXb8myFuVe1IWYW84un5rkH+CYUTVVXGDY0Vf2LXRizggIg5lZdbGRhx4gjg0VVobG3EoKlbGRhxa6pWxEccZXz7VKFnGxkOw55bNomFziBZ5DPoEcTxw/l8XrR0QcTxQ+7A4jziuKrw8iOOxruVRtQ/iEHG4EIeOksujIw7FT3nJot7h0nUR2RwQEccX6i2P84jja8v2QRwQEccpay6PvjgWfMOyK9BH7+Vjc0BEHB0KLI8uxNFnqWfq3XGsfNvRK9TyGLhwbI5u6xwuxDFikcOFOKbLuzxG4uC2Y8t2uIxdMjYHRMQxLtfyGDAYBydLk6IPPh0S+sbjYHk0wZfHlcvE5lAQvI9hxAHRpTg4WXYxl8fFC8TmUFPvmfrVOFgeYwyWx/VLw+bQFPNwGaYQB8vjKMjhonJR2Byegi8PnThYHkcnl8fr++ekNaN1OdQ2B310mXf6KF4IjpUpnlz7eQtD3bdfP14Uvxwf2HNk/5GAuvubzWEky7Y4Ut4cG8vj/35/vJlloX7bpx/HRh8eZrwhmHKs8M7F2KSBc88B0aw4WB5m5o164uagDwNThzz3WKGPqWaPl3sOiKbHwfKYxGCwFpuDPtTZjNToWKEPRWbDtLvnoA8VlmM0vSGlj4uMB2j9boU+htmPzuGtLH0McBmaz3MO+ujiNS63Dx1uL5gf7j/n+3+R8xNSVsgT7sPxf3zuPoKYIowlxGfZc8QcRcii8d8cuzhDcRRqCIHi2IKNxl60lx/iWDla84iJlkUTLo5mnURiZtHEOlZuRB6ciuAvMOjm2FVdIcGzaKLH0VRKJEUWTY44muyJJMqiyRRHs484SyXpmtjli2MXf5HkzaJJHEcTcJFkb2KXPo7d8ZLYh1ImiKM6cRzZhFIyiKOacRzdX8KxXMqncK9+HPcWvMxjQj8+hy/igIg4ICIOiIgDIuKAiDggIg6IiAMi4oCIOCAiDoiIA6L/ANM3zXjR+SvfAAAAAElFTkSuQmCC">
<meta name="apple-mobile-web-app-title" content="Rewind">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=DM+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0b09;
    --surface: #1a1410;
    --surface2: #221c16;
    --warm: #c4956a;
    --warm-soft: #8b6540;
    --warm-glow: rgba(196, 149, 106, 0.12);
    --text: #e8ddd4;
    --text-soft: #9a8878;
    --text-muted: #5a4e45;
    --border: rgba(196, 149, 106, 0.15);
    --border-soft: rgba(255,255,255,0.05);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 300;
  }

  /* Ambient background */
  .ambient {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }

  .ambient-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0;
    transition: opacity 3s ease;
  }

  .ambient-orb.a1 {
    width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(196,149,106,0.15), transparent 70%);
    top: -80px; right: -60px;
  }

  .ambient-orb.a2 {
    width: 250px; height: 250px;
    background: radial-gradient(circle, rgba(139,101,64,0.1), transparent 70%);
    bottom: 10%; left: -80px;
  }

  .ambient-orb.visible { opacity: 1; }

  /* Grain overlay */
  .grain {
    position: fixed;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-size: 128px;
  }

  /* Main layout */
  .app {
    position: relative;
    z-index: 2;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Screens */
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    padding: 0 28px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.6s ease, transform 0.6s ease;
    transform: translateY(12px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .screen.active {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }

  .screen.exit {
    opacity: 0;
    transform: translateY(-12px);
  }

  /* â”€â”€ WELCOME SCREEN â”€â”€ */
  #screen-welcome {
    justify-content: center;
    align-items: center;
    text-align: center;
    gap: 0;
  }

  .welcome-time {
    font-size: 13px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 48px;
    opacity: 0;
    animation: fadeUp 0.8s ease 0.3s forwards;
  }

  .rewind-logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 52px;
    font-weight: 300;
    color: var(--warm);
    letter-spacing: 8px;
    text-transform: uppercase;
    margin-bottom: 12px;
    opacity: 0;
    animation: fadeUp 0.8s ease 0.5s forwards;
  }

  .rewind-tagline {
    font-size: 13px;
    color: var(--text-muted);
    letter-spacing: 1px;
    margin-bottom: 72px;
    opacity: 0;
    animation: fadeUp 0.8s ease 0.7s forwards;
  }

  .welcome-question {
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px;
    font-weight: 300;
    font-style: italic;
    color: var(--text);
    line-height: 1.5;
    margin-bottom: 48px;
    opacity: 0;
    animation: fadeUp 0.8s ease 0.9s forwards;
  }

  .returning-msg {
    display: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 40px;
    font-size: 14px;
    color: var(--text-soft);
    line-height: 1.6;
    text-align: left;
    opacity: 0;
    animation: fadeUp 0.8s ease 0.9s forwards;
  }

  .returning-msg.show { display: block; }

  .returning-msg .days-away {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    color: var(--warm);
    display: block;
    margin-bottom: 6px;
  }

  .begin-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--warm);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 16px 40px;
    border-radius: 40px;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    animation: fadeUp 0.8s ease 1.1s forwards;
  }

  .begin-btn:active {
    background: var(--warm-glow);
    border-color: var(--warm);
    transform: scale(0.97);
  }

  /* â”€â”€ CHECK-IN SCREEN â”€â”€ */
  #screen-checkin {
    padding-top: 72px;
    padding-bottom: 40px;
  }

  .checkin-step {
    display: none;
    flex-direction: column;
    min-height: calc(100vh - 112px);
  }

  .checkin-step.active { display: flex; }

  .step-indicator {
    display: flex;
    gap: 6px;
    margin-bottom: 48px;
  }

  .step-dot {
    width: 24px;
    height: 2px;
    border-radius: 2px;
    background: var(--text-muted);
    transition: background 0.4s, width 0.4s;
  }

  .step-dot.done { background: var(--warm-soft); }
  .step-dot.active { background: var(--warm); width: 40px; }

  .step-q {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 300;
    font-style: italic;
    color: var(--text);
    line-height: 1.45;
    margin-bottom: 12px;
  }

  .step-sub {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 40px;
    line-height: 1.6;
  }

  /* Mood selector */
  .mood-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 32px;
  }

  .mood-btn {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 18px 14px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .mood-btn:active { transform: scale(0.97); }

  .mood-btn.selected {
    border-color: var(--warm);
    background: var(--warm-glow);
  }

  .mood-icon { font-size: 26px; line-height: 1; }

  .mood-label {
    font-size: 12px;
    color: var(--text-soft);
    letter-spacing: 0.5px;
  }

  .mood-btn.selected .mood-label { color: var(--warm); }

  /* Intensity slider */
  .intensity-wrap {
    margin-bottom: 32px;
  }

  .intensity-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  input[type=range] {
    width: 100%;
    -webkit-appearance: none;
    height: 2px;
    background: linear-gradient(to right, var(--warm) 0%, var(--warm) 50%, var(--text-muted) 50%);
    border-radius: 2px;
    outline: none;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--warm);
    cursor: pointer;
    box-shadow: 0 0 12px rgba(196, 149, 106, 0.4);
  }

  /* Text input */
  .rewind-textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 18px;
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 300;
    line-height: 1.6;
    resize: none;
    outline: none;
    min-height: 140px;
    transition: border-color 0.3s;
    margin-bottom: 12px;
  }

  .rewind-textarea::placeholder { color: var(--text-muted); font-style: italic; }
  .rewind-textarea:focus { border-color: var(--warm-soft); }

  .skip-link {
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
    cursor: pointer;
    padding: 8px;
    letter-spacing: 1px;
  }

  /* Focus input */
  .focus-input {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 18px;
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    width: 100%;
    outline: none;
    transition: border-color 0.3s;
    margin-bottom: 12px;
  }

  .focus-input::placeholder { color: var(--text-muted); font-style: italic; }
  .focus-input:focus { border-color: var(--warm-soft); }

  .step-next {
    margin-top: auto;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--warm);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 16px;
    border-radius: 40px;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s;
    margin-top: 32px;
  }

  .step-next:active {
    background: var(--warm-glow);
    transform: scale(0.98);
  }

  /* â”€â”€ REFLECTION SCREEN â”€â”€ */
  #screen-reflection {
    padding-top: 72px;
    padding-bottom: 60px;
  }

  .reflection-header {
    margin-bottom: 40px;
  }

  .reflection-eyebrow {
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--warm-soft);
    margin-bottom: 12px;
  }

  .reflection-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 300;
    color: var(--text);
    line-height: 1.3;
  }

  .reflection-card {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
  }

  .reflection-card-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .reflection-card-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    color: var(--text);
    line-height: 1.5;
    font-style: italic;
  }

  .focus-card {
    background: var(--warm-glow);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .focus-card-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--warm-soft);
    margin-bottom: 10px;
  }

  .focus-card-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    color: var(--warm);
    line-height: 1.4;
  }

  .rewind-response {
    font-family: 'Cormorant Garamond', serif;
    font-size: 19px;
    font-style: italic;
    color: var(--text-soft);
    line-height: 1.7;
    padding: 24px 0;
    border-top: 1px solid var(--border-soft);
    border-bottom: 1px solid var(--border-soft);
    margin-bottom: 32px;
  }

  .done-btn {
    width: 100%;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--warm);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 16px;
    border-radius: 40px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 16px;
  }

  .done-btn:active { background: var(--warm-glow); transform: scale(0.98); }

  .new-session-btn {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    letter-spacing: 1px;
    padding: 12px;
    cursor: pointer;
  }

  /* â”€â”€ PATTERN SCREEN â”€â”€ */
  #screen-history {
    padding-top: 0;
    padding-bottom: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0;
  }

  .pattern-hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    padding: 80px 28px 60px;
  }

  .pattern-eyebrow {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--warm-soft);
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.6s ease 0.2s forwards;
  }

  .pattern-hero-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 52px;
    font-weight: 300;
    color: var(--text);
    line-height: 1.15;
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.6s ease 0.4s forwards;
  }

  .pattern-hero-title em {
    font-style: italic;
    color: var(--warm);
  }

  .pattern-sub {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 0;
    opacity: 0;
    animation: fadeUp 0.6s ease 0.6s forwards;
  }

  .pattern-scroll-hint {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    margin-top: 48px;
    opacity: 0;
    animation: fadeUp 0.6s ease 1.2s forwards;
  }

  .pattern-reveal-wrap {
    padding: 0 28px;
    border-top: 1px solid var(--border-soft);
  }

  /* Scroll reveal animation */
  .reveal-section {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.7s ease, transform 0.7s ease;
    padding: 32px 0 0;
  }

  .reveal-section.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .history-header {
    margin-bottom: 24px;
  }

  .history-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 300;
    color: var(--text);
    margin-bottom: 6px;
  }

  .history-sub {
    font-size: 13px;
    color: var(--text-muted);
  }

  .history-entry {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 18px 20px;
    margin-bottom: 12px;
  }

  .history-date {
    font-size: 11px;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .history-mood {
    font-size: 20px;
    margin-bottom: 6px;
  }

  .history-focus {
    font-family: 'Cormorant Garamond', serif;
    font-size: 17px;
    color: var(--warm);
    font-style: italic;
    margin-bottom: 6px;
  }

  .history-feeling {
    font-size: 13px;
    color: var(--text-soft);
    line-height: 1.5;
  }

  .empty-history {
    text-align: center;
    padding: 60px 20px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    color: var(--text-muted);
    font-style: italic;
    line-height: 1.6;
  }

  /* â”€â”€ PATTERN SCREEN â”€â”€ */
  .pattern-section {
    margin-bottom: 24px;
  }

  .pattern-section-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 12px;
    font-weight: 400;
  }

  .insights-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 24px;
  }

  .insight-card {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 16px;
  }

  .insight-card.full {
    grid-column: 1 / -1;
  }

  .insight-card.highlight {
    border-color: var(--border);
    background: var(--warm-glow);
  }

  .insight-label {
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .insight-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    color: var(--warm);
    line-height: 1.2;
  }

  .insight-sub {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
    line-height: 1.4;
  }

  .cycle-bar-wrap {
    margin-top: 10px;
  }

  .cycle-bar {
    height: 4px;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .cycle-bar-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(to right, var(--warm-soft), var(--warm));
    transition: width 0.8s ease;
  }

  .mood-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .mood-bar-label {
    font-size: 12px;
    color: var(--text-soft);
    width: 64px;
    flex-shrink: 0;
  }

  .mood-bar-track {
    flex: 1;
    height: 6px;
    background: var(--surface2);
    border-radius: 4px;
    overflow: hidden;
  }

  .mood-bar-fill {
    height: 100%;
    border-radius: 4px;
    background: var(--warm);
    transition: width 0.6s ease;
  }

  .mood-bar-count {
    font-size: 11px;
    color: var(--text-muted);
    width: 20px;
    text-align: right;
    flex-shrink: 0;
  }

  .pattern-chart-wrap {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
  }

  /* Export */
  .export-wrap {
    margin-bottom: 8px;
  }

  .export-btns {
    display: flex;
    gap: 10px;
  }

  .export-btn {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 16px 12px;
    cursor: pointer;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }

  .export-btn:active {
    border-color: var(--warm);
    background: var(--warm-glow);
    transform: scale(0.97);
  }

  .export-icon {
    font-size: 20px;
    color: var(--warm);
    font-family: 'Cormorant Garamond', serif;
    line-height: 1;
    margin-bottom: 4px;
  }

  .export-label {
    font-size: 13px;
    color: var(--text);
    font-weight: 400;
    letter-spacing: 1px;
  }

  .export-sub {
    font-size: 11px;
    color: var(--text-muted);
  }

  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--warm);
    font-size: 13px;
    padding: 10px 24px;
    border-radius: 40px;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
    white-space: nowrap;
    z-index: 100;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }



  /* Bottom nav */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    z-index: 10;
    display: flex;
    background: rgba(14, 11, 9, 0.92);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border-soft);
    padding: 12px 0 max(12px, env(safe-area-inset-bottom));
  }

  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    transition: opacity 0.2s;
  }

  .nav-icon {
    font-size: 20px;
    line-height: 1;
    filter: grayscale(1) opacity(0.4);
    transition: filter 0.3s;
  }

  .nav-label {
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-muted);
    transition: color 0.3s;
  }

  .nav-btn.active .nav-icon { filter: none; }
  .nav-btn.active .nav-label { color: var(--warm); }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  /* Breathing orb on welcome */
  .breath-orb {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(196,149,106,0.3), rgba(196,149,106,0.05));
    margin: 0 auto 40px;
    animation: breathe 4s ease-in-out infinite;
    opacity: 0;
    animation-delay: 1.3s;
  }

  @keyframes breathe {
    0%, 100% { transform: scale(0.9); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 1; }
  }

  /* New element pulse for updates */
  @keyframes newPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(196, 149, 106, 0); }
    50% { box-shadow: 0 0 0 8px rgba(196, 149, 106, 0.18); }
  }

  .new-pulse {
    animation: newPulse 1.8s ease-in-out infinite !important;
    border-color: rgba(196, 149, 106, 0.4) !important;
  }

  /* Welcome screen â€” scrollable */
  #screen-welcome {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0;
  }

  .welcome-hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 60px 28px 60px;
  }

  .scroll-hint {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin-top: 32px;
    animation: fadeUp 0.8s ease 2s forwards;
    opacity: 0;
  }

  .scroll-hint-line {
    width: 1px;
    height: 32px;
    background: linear-gradient(to bottom, transparent, var(--text-muted));
  }

  .scroll-hint-text {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .scroll-hint-arrow {
    font-size: 14px;
    color: var(--text-muted);
    animation: bobDown 1.8s ease-in-out infinite;
  }

  @keyframes bobDown {
    0%, 100% { transform: translateY(0); opacity: 0.4; }
    50% { transform: translateY(5px); opacity: 1; }
  }

  /* Recent entries section */
  .recent-section {
    padding: 0 28px;
    border-top: 1px solid var(--border-soft);
  }

  .recent-label {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin: 32px 0 16px;
  }

  .recent-entry {
    background: var(--surface);
    border: 1px solid var(--border-soft);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
  }

  .recent-entry::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--warm-soft);
    border-radius: 3px 0 0 3px;
    opacity: 0.6;
  }

  .recent-entry-time {
    font-size: 11px;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .recent-entry-mood {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .recent-mood-icon { font-size: 22px; }

  .recent-mood-name {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    color: var(--text);
    font-weight: 300;
  }

  .recent-mood-intensity {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
  }

  .recent-entry-feeling {
    font-family: 'Cormorant Garamond', serif;
    font-size: 17px;
    color: var(--text-soft);
    line-height: 1.65;
    font-style: italic;
    margin-bottom: 10px;
  }

  .recent-entry-focus {
    font-size: 12px;
    color: var(--warm-soft);
    letter-spacing: 0.5px;
  }

  .recent-entry-focus span {
    color: var(--warm);
    font-family: 'Cormorant Garamond', serif;
    font-size: 15px;
    font-style: italic;
  }

  .recent-divider {
    text-align: center;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 16px 0;
    cursor: pointer;
  }

  .recent-divider:active { color: var(--warm); }

</style>
</head>
<body>

<div class="ambient">
  <div class="ambient-orb a1"></div>
  <div class="ambient-orb a2"></div>
</div>
<div class="grain"></div>

<div class="app">

  <!-- WELCOME -->
  <div class="screen active" id="screen-welcome">

    <!-- Hero section â€” full viewport height -->
    <div class="welcome-hero">
      <p class="welcome-time" id="welcome-time">Evening</p>
      <div class="breath-orb" id="breath-orb"></div>
      <h1 class="rewind-logo">Rewind</h1>
      <p class="rewind-tagline">return to yourself</p>
      <div class="returning-msg" id="returning-msg">
        <span class="days-away" id="days-away-text"></span>
        <span id="returning-body"></span>
      </div>
      <p class="welcome-question" id="welcome-question">How are you coming in<br>right now?</p>
      <button class="begin-btn" id="begin-btn" onclick="startCheckin()">Begin</button>
      <div class="scroll-hint" id="scroll-hint" style="display:none;">
        <div class="scroll-hint-line"></div>
        <span class="scroll-hint-text">scroll to read back</span>
        <div class="scroll-hint-arrow">â†“</div>
      </div>
    </div>

    <!-- Recent entries revealed on scroll -->
    <div class="recent-section" id="recent-section" style="display:none;">
      <p class="recent-label">Recently</p>
      <div id="recent-entries"></div>
      <div style="height: 100px;"></div>
    </div>

  </div>

  <!-- UPDATE CARD OVERLAY -->
  <div id="update-overlay" style="display:none; position:fixed; inset:0; z-index:200; background:rgba(14,11,9,0.96); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); flex-direction:column; justify-content:center; align-items:center; padding:40px 32px; text-align:center;">
    <div id="update-card-inner" style="opacity:0; transform:translateY(16px); transition: opacity 0.6s ease, transform 0.6s ease;">
      <p style="font-size:11px; letter-spacing:3px; text-transform:uppercase; color:var(--warm-soft); margin-bottom:24px;">Rewind grew a little</p>
      <h2 id="update-message" style="font-family:'Cormorant Garamond',serif; font-size:36px; font-weight:300; color:var(--text); margin-bottom:20px; line-height:1.3;"></h2>
      <p id="update-body" style="font-size:15px; color:var(--text-soft); line-height:1.8; margin-bottom:48px; max-width:320px;"></p>
      <div style="width:40px; height:1px; background:var(--border); margin:0 auto 32px;"></div>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:32px; letter-spacing:0.5px;">Your entries are safe. Your pattern continues.</p>
      <button onclick="dismissUpdate()" style="background:transparent; border:1px solid var(--border); color:var(--warm); font-family:'DM Sans',sans-serif; font-size:12px; letter-spacing:3px; text-transform:uppercase; padding:14px 36px; border-radius:40px; cursor:pointer;">Continue â†’</button>
    </div>
  </div>

  <!-- CONTEXT HINT TOOLTIP -->
  <div id="context-hint" style="display:none; position:fixed; z-index:150; pointer-events:none;">
    <div id="context-hint-inner" style="background:var(--surface2); border:1px solid var(--border); color:var(--warm); font-size:11px; letter-spacing:1px; padding:8px 14px; border-radius:20px; white-space:nowrap; opacity:0; transition:opacity 0.4s ease;"></div>
  </div>

  <!-- CHECK-IN -->
  <div class="screen" id="screen-checkin">

    <div class="step-indicator">
      <div class="step-dot active" id="dot-0"></div>
      <div class="step-dot" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
    </div>

    <!-- Step 1: Mood -->
    <div class="checkin-step active" id="step-0">
      <p class="step-q">What is the weather<br>inside you right now?</p>
      <p class="step-sub">Don't think too long. First feeling.</p>
      <div class="mood-grid">
        <button class="mood-btn" onclick="selectMood(this, 'Heavy')" data-mood="Heavy">
          <span class="mood-icon">ðŸŒ§</span>
          <span class="mood-label">Heavy</span>
        </button>
        <button class="mood-btn" onclick="selectMood(this, 'Tired')" data-mood="Tired">
          <span class="mood-icon">ðŸŒ«</span>
          <span class="mood-label">Tired</span>
        </button>
        <button class="mood-btn" onclick="selectMood(this, 'Restless')" data-mood="Restless">
          <span class="mood-icon">âš¡</span>
          <span class="mood-label">Restless</span>
        </button>
        <button class="mood-btn" onclick="selectMood(this, 'Okay')" data-mood="Okay">
          <span class="mood-icon">ðŸŒ¤</span>
          <span class="mood-label">Okay</span>
        </button>
        <button class="mood-btn" onclick="selectMood(this, 'Calm')" data-mood="Calm">
          <span class="mood-icon">ðŸŒŠ</span>
          <span class="mood-label">Calm</span>
        </button>
        <button class="mood-btn" onclick="selectMood(this, 'Alive')" data-mood="Alive">
          <span class="mood-icon">âœ¨</span>
          <span class="mood-label">Alive</span>
        </button>
      </div>
      <div class="intensity-wrap">
        <div class="intensity-labels"><span>Barely</span><span>How much?</span><span>Fully</span></div>
        <input type="range" id="intensity" min="1" max="10" value="5" oninput="updateIntensity(this)">
      </div>
      <button class="step-next" onclick="nextStep(1)">Continue â†’</button>
    </div>

    <!-- Step 2: Feeling / spark -->
    <div class="checkin-step" id="step-1">
      <p class="step-q">What's sitting<br>with you right now?</p>
      <p class="step-sub">A feeling, a thought, a spark of an idea. Anything. Even if it's half-formed.</p>
      <textarea class="rewind-textarea" id="feeling-input" placeholder="Just let it out here..." rows="5"></textarea>
      <p class="skip-link" onclick="skipFeeling()">Nothing right now â€” skip</p>
      <button class="step-next" onclick="nextStep(2)">Continue â†’</button>
    </div>

    <!-- Step 3: One focus -->
    <div class="checkin-step" id="step-2">
      <p class="step-q">What is the one thing<br>that matters today?</p>
      <p class="step-sub">Not a list. Just one. The truest, smallest next thing.</p>
      <input type="text" class="focus-input" id="focus-input" placeholder="One thing only...">
      <p class="skip-link" onclick="skipFocus()">Rest is the focus today</p>
      <button class="step-next" onclick="completeCheckin()">See my reflection â†’</button>
    </div>

  </div>

  <!-- REFLECTION -->
  <div class="screen" id="screen-reflection">
    <div class="reflection-header">
      <p class="reflection-eyebrow">Your check-in</p>
      <h2 class="reflection-title" id="reflection-title">Here is where<br>you are.</h2>
    </div>

    <div class="reflection-card">
      <p class="reflection-card-label">Weather inside</p>
      <p class="reflection-card-value" id="reflection-mood">â€”</p>
    </div>

    <div class="reflection-card" id="reflection-feeling-card">
      <p class="reflection-card-label">What you're carrying</p>
      <p class="reflection-card-value" id="reflection-feeling">â€”</p>
    </div>

    <div class="focus-card" id="reflection-focus-card">
      <p class="focus-card-label">One thing today</p>
      <p class="focus-card-value" id="reflection-focus">â€”</p>
    </div>

    <p class="rewind-response" id="rewind-response">â€”</p>

    <button class="done-btn" onclick="goHome()">Close for now</button>
    <button class="new-session-btn" onclick="startCheckin()">Start a new check-in</button>
  </div>

  <!-- PATTERN -->
  <div class="screen" id="screen-history">

    <!-- Clean landing hero -->
    <div class="pattern-hero">
      <p class="pattern-eyebrow">Your pattern</p>
      <h2 class="pattern-hero-title" id="pattern-hero-title">Reading<br><em>your rhythm.</em></h2>
      <p class="pattern-sub" id="pattern-sub"></p>
      <div class="pattern-scroll-hint" id="pattern-scroll-hint" style="display:none;">
        <div class="scroll-hint-line"></div>
        <span class="scroll-hint-text">scroll to see your pattern</span>
        <div class="scroll-hint-arrow">â†“</div>
      </div>
    </div>

    <!-- Scroll reveal sections -->
    <div class="pattern-reveal-wrap" id="pattern-reveal-wrap" style="display:none;">

      <!-- Insights -->
      <div class="reveal-section" id="reveal-insights">
        <div id="pattern-insights"></div>
      </div>

      <!-- Export -->
      <div class="reveal-section" id="reveal-export">
        <div class="export-wrap">
          <p class="pattern-section-label">Export your data</p>
          <div class="export-btns">
            <button class="export-btn" onclick="exportJSON()">
              <span class="export-icon">{ }</span>
              <span class="export-label">JSON</span>
              <span class="export-sub">Raw data</span>
            </button>
            <button class="export-btn" onclick="exportPDF()">
              <span class="export-icon">â†“</span>
              <span class="export-label">PDF</span>
              <span class="export-sub">Readable</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Full log -->
      <div class="reveal-section" id="reveal-log">
        <p class="pattern-section-label">Full log</p>
        <div id="history-list"></div>
        <div style="height:100px;"></div>
      </div>

    </div>

  </div>

</div>

<!-- Bottom nav -->
<nav class="bottom-nav" id="bottom-nav" style="display:none;">
  <button class="nav-btn active" id="nav-home" onclick="navigate('welcome')">
    <span class="nav-icon">ðŸŒ¬</span>
    <span class="nav-label">Rewind</span>
  </button>
  <button class="nav-btn" id="nav-checkin" onclick="startCheckin()">
    <span class="nav-icon">â—‹</span>
    <span class="nav-label">Check in</span>
  </button>
  <button class="nav-btn" id="nav-history" onclick="navigate('history')">
    <span class="nav-icon">â—Ž</span>
    <span class="nav-label">Pattern</span>
  </button>
</nav>

<script>
// â”€â”€ VERSION & UPDATE SYSTEM â”€â”€
const REWIND_VERSION = '1.2.0';

const UPDATES = {
  '1.1.0': {
    message: "I learned something new.",
    body: "Your pattern screen now reads your rhythm â€” not just lists your entries. Mood trends, cycle detection, what keeps showing up in your focus. I also added export so your data is always yours to keep.",
    newElements: [
      { selector: '#nav-history', hint: 'Pattern screen is smarter now' }
    ]
  },
  '1.2.0': {
    message: "Something is closer now.",
    body: "Your recent entries are just a scroll away from home. No need to navigate anywhere â€” when you want to read back what you wrote a few hours ago, just scroll down. Everything is still here. Nothing changed, just moved a little nearer.",
    newElements: [
      { selector: '#scroll-hint', hint: 'Scroll down to read recent entries' },
      { selector: '.recent-section', hint: 'Your recent check-ins live here now' }
    ]
  }
};

// â”€â”€ STATE â”€â”€
let state = {
  mood: null,
  intensity: 5,
  feeling: '',
  focus: '',
  currentStep: 0
};

let sessions = [];

// â”€â”€ STORAGE â”€â”€
function saveSession(session) {
  try {
    sessions.push(session);
    localStorage.setItem('rewind_sessions', JSON.stringify(sessions));
  } catch(e) { sessions.push(session); }
}

function loadSessions() {
  try {
    const s = localStorage.getItem('rewind_sessions');
    if (s) sessions = JSON.parse(s);
  } catch(e) { sessions = []; }
}

function getLastSession() {
  return sessions.length > 0 ? sessions[sessions.length - 1] : null;
}

function getDaysSince(dateStr) {
  const then = new Date(dateStr);
  const now = new Date();
  return Math.floor((now - then) / (1000 * 60 * 60 * 24));
}

// â”€â”€ INIT â”€â”€
function init() {
  loadSessions();

  // Check for update
  const seenVersion = localStorage.getItem('rewind_seen_version') || '1.0.0';
  if (seenVersion !== REWIND_VERSION) {
    const update = UPDATES[REWIND_VERSION];
    if (update) {
      setTimeout(() => showUpdateCard(update), 800);
    }
  }

  // Ambient orbs
  setTimeout(() => {
    document.querySelectorAll('.ambient-orb').forEach(o => o.classList.add('visible'));
  }, 500);

  // Breathing orb
  setTimeout(() => {
    document.getElementById('breath-orb').classList.add('loaded');
  }, 100);

  // Time greeting
  const hour = new Date().getHours();
  let timeLabel = 'Evening';
  let question = 'How are you coming in\nright now?';
  if (hour >= 5 && hour < 12) { timeLabel = 'Morning'; question = 'How are you waking\ninto today?'; }
  else if (hour >= 12 && hour < 17) { timeLabel = 'Afternoon'; question = 'How is the day\nsitting with you?'; }
  else if (hour >= 17 && hour < 20) { timeLabel = 'Evening'; question = 'How are you coming\nhome today?'; }
  else { timeLabel = 'Late night'; question = 'The quiet hour.\nHow are you, really?'; }

  document.getElementById('welcome-time').textContent = timeLabel;
  document.getElementById('welcome-question').textContent = question;

  // Returning user
  const last = getLastSession();
  if (last) {
    const days = getDaysSince(last.date);
    const returning = document.getElementById('returning-msg');
    returning.classList.add('show');

    if (days === 0) {
      document.getElementById('days-away-text').textContent = 'Welcome back.';
      document.getElementById('returning-body').textContent = `You were here earlier today. The space is still here.`;
    } else if (days === 1) {
      document.getElementById('days-away-text').textContent = 'Yesterday you were here.';
      document.getElementById('returning-body').textContent = `Your focus was: "${last.focus || 'rest'}". You're back. That's what matters.`;
    } else if (days <= 7) {
      document.getElementById('days-away-text').textContent = `${days} days since your last check-in.`;
      document.getElementById('returning-body').textContent = `No judgment. You're here now. The space held.`;
    } else {
      document.getElementById('days-away-text').textContent = `It's been a while.`;
      document.getElementById('returning-body').textContent = `${days} days. The cocoon does what it needs to. Welcome back â€” no streak broken, nothing lost.`;
    }

    document.getElementById('welcome-question').style.display = 'none';
  }

  // Show nav after first init
  if (sessions.length > 0) {
    document.getElementById('bottom-nav').style.display = 'flex';
    renderRecentEntries();
  }
}

// â”€â”€ NAVIGATION â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.remove('active', 'exit');
  });
  setTimeout(() => {
    document.getElementById('screen-' + id).classList.add('active');
  }, 50);

  // Nav state
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (id === 'welcome') document.getElementById('nav-home').classList.add('active');
  if (id === 'history') document.getElementById('nav-history').classList.add('active');
  if (id === 'checkin') document.getElementById('nav-checkin').classList.add('active');
}

function navigate(screen) {
  if (screen === 'history') renderHistory();
  showScreen(screen);
}

function goHome() {
  document.getElementById('bottom-nav').style.display = 'flex';
  showScreen('welcome');
  document.getElementById('nav-home').classList.add('active');
}

// â”€â”€ CHECK-IN FLOW â”€â”€
function startCheckin() {
  state = { mood: null, intensity: 5, feeling: '', focus: '', currentStep: 0 };
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('feeling-input').value = '';
  document.getElementById('focus-input').value = '';
  document.getElementById('intensity').value = 5;
  updateIntensity(document.getElementById('intensity'));

  setStep(0);
  showScreen('checkin');
  document.getElementById('nav-checkin').classList.add('active');
}

function setStep(n) {
  document.querySelectorAll('.checkin-step').forEach((s, i) => {
    s.classList.toggle('active', i === n);
  });
  document.querySelectorAll('.step-dot').forEach((d, i) => {
    d.classList.remove('active', 'done');
    if (i < n) d.classList.add('done');
    if (i === n) d.classList.add('active');
  });
  state.currentStep = n;
}

function selectMood(btn, mood) {
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.mood = mood;
}

function updateIntensity(input) {
  const val = input.value;
  const pct = ((val - 1) / 9) * 100;
  input.style.background = `linear-gradient(to right, var(--warm) 0%, var(--warm) ${pct}%, var(--text-muted) ${pct}%)`;
  state.intensity = parseInt(val);
}

function nextStep(n) {
  if (n === 1 && !state.mood) {
    state.mood = 'Okay';
  }
  setStep(n);
}

function skipFeeling() {
  state.feeling = '';
  setStep(2);
}

function skipFocus() {
  state.focus = 'Rest';
  completeCheckin();
}

function completeCheckin() {
  state.feeling = document.getElementById('feeling-input').value.trim();
  state.focus = document.getElementById('focus-input').value.trim() || state.focus || 'Rest';

  const session = {
    date: new Date().toISOString(),
    mood: state.mood || 'Okay',
    intensity: state.intensity,
    feeling: state.feeling,
    focus: state.focus
  };

  saveSession(session);
  renderReflection(session);
  showScreen('reflection');
  document.getElementById('bottom-nav').style.display = 'flex';
}

// â”€â”€ REFLECTION â”€â”€
const responses = {
  Heavy: [
    "Heavy is real. You don't have to carry it gracefully right now. Just carry it.",
    "Something is weighing on you. That's okay. You showed up anyway.",
    "Let the heaviness be here. You don't have to fix it tonight."
  ],
  Tired: [
    "Tired is honest. You've been doing a lot. Rest is not falling behind.",
    "Your body is asking for something. Listen when you can.",
    "The tiredness is information. It's telling you something true."
  ],
  Restless: [
    "The restlessness wants to go somewhere. One small thing, not everything.",
    "That energy is real. Channel just one part of it tonight.",
    "Restless often means something is ready to move. Be curious about what."
  ],
  Okay: [
    "Okay is enough. Not every day needs to be more than this.",
    "Okay is stable ground. You can build from here.",
    "Okay means you're here, holding things. That counts."
  ],
  Calm: [
    "Calm is rare. Let yourself receive it.",
    "This is a good moment to let something go that you've been holding.",
    "Calm is the weather your best thinking happens in."
  ],
  Alive: [
    "Hold onto this feeling. It's data about what matters to you.",
    "Notice what brought this. It's pointing at something real.",
    "This is you at your most you. Remember it for the harder days."
  ]
};

function getResponse(mood, focus) {
  const moodResponses = responses[mood] || responses['Okay'];
  let r = moodResponses[Math.floor(Math.random() * moodResponses.length)];
  if (focus && focus !== 'Rest') {
    r += ` Your one thing today: "${focus}." Just that. Nothing else needs to happen.`;
  } else if (focus === 'Rest') {
    r += ' Rest is the right choice. Let it be enough.';
  }
  return r;
}

function renderReflection(session) {
  const moodIcons = { Heavy:'ðŸŒ§', Tired:'ðŸŒ«', Restless:'âš¡', Okay:'ðŸŒ¤', Calm:'ðŸŒŠ', Alive:'âœ¨' };
  const icon = moodIcons[session.mood] || 'â—‹';

  document.getElementById('reflection-mood').textContent =
    `${icon}  ${session.mood}  Â·  ${session.intensity}/10`;

  if (session.feeling) {
    document.getElementById('reflection-feeling').textContent = session.feeling;
    document.getElementById('reflection-feeling-card').style.display = 'block';
  } else {
    document.getElementById('reflection-feeling-card').style.display = 'none';
  }

  document.getElementById('reflection-focus').textContent = session.focus;
  document.getElementById('rewind-response').textContent = getResponse(session.mood, session.focus);

  const titles = { Heavy: 'Be gentle\nwith yourself.', Tired: 'You can rest\nhere first.', Restless: 'One thing.\nNot everything.', Okay: 'Here is where\nyou are.', Calm: 'Receive\nthis moment.', Alive: 'Hold onto\nthis.' };
  document.getElementById('reflection-title').textContent = titles[session.mood] || 'Here is where\nyou are.';
}

// â”€â”€ PATTERN & INSIGHTS â”€â”€
function renderHistory() {
  const list = document.getElementById('history-list');
  const insights = document.getElementById('pattern-insights');
  const sub = document.getElementById('pattern-sub');
  const heroTitle = document.getElementById('pattern-hero-title');
  const revealWrap = document.getElementById('pattern-reveal-wrap');
  const scrollHint = document.getElementById('pattern-scroll-hint');

  if (sessions.length === 0) {
    insights.innerHTML = '';
    sub.textContent = 'Your check-ins will build a picture over time.';
    heroTitle.innerHTML = 'Nothing yet.<br><em>Begin when ready.</em>';
    revealWrap.style.display = 'none';
    scrollHint.style.display = 'none';
    list.innerHTML = '';
    return;
  }

  sub.textContent = `${sessions.length} check-in${sessions.length > 1 ? 's' : ''} recorded`;
  heroTitle.innerHTML = sessions.length === 1
    ? 'Your pattern<br><em>is beginning.</em>'
    : 'Here is<br><em>your rhythm.</em>';

  scrollHint.style.display = 'flex';
  revealWrap.style.display = 'block';

  // â”€â”€ Compute insights â”€â”€
  const moodCounts = {};
  const moodIcons = { Heavy:'ðŸŒ§', Tired:'ðŸŒ«', Restless:'âš¡', Okay:'ðŸŒ¤', Calm:'ðŸŒŠ', Alive:'âœ¨' };
  const moodOrder = ['Heavy','Tired','Restless','Okay','Calm','Alive'];
  let totalIntensity = 0;
  let focusEntries = sessions.filter(s => s.focus && s.focus !== 'Rest').map(s => s.focus);

  sessions.forEach(s => {
    moodCounts[s.mood] = (moodCounts[s.mood] || 0) + 1;
    totalIntensity += s.intensity || 5;
  });

  const avgIntensity = (totalIntensity / sessions.length).toFixed(1);
  const dominantMood = Object.entries(moodCounts).sort((a,b) => b[1]-a[1])[0];

  let cycleText = 'â€”';
  if (sessions.length >= 3) {
    const gaps = [];
    for (let i = 1; i < sessions.length; i++) {
      const diff = (new Date(sessions[i].date) - new Date(sessions[i-1].date)) / (1000*60*60*24);
      gaps.push(diff);
    }
    const avgGap = gaps.reduce((a,b) => a+b, 0) / gaps.length;
    if (avgGap < 1.5) cycleText = 'Daily rhythm';
    else if (avgGap < 3) cycleText = `Every ~${avgGap.toFixed(1)} days`;
    else if (avgGap < 8) cycleText = `Every ~${Math.round(avgGap)} days`;
    else cycleText = `Every ~${Math.round(avgGap)} days`;
  }

  let focusInsight = 'â€”';
  if (focusEntries.length > 0) {
    const words = focusEntries.join(' ').toLowerCase()
      .split(/\s+/)
      .filter(w => w.length > 3 && !['this','that','have','with','from','just','will','been','they','your','when'].includes(w));
    const wordCount = {};
    words.forEach(w => wordCount[w] = (wordCount[w]||0)+1);
    const topWord = Object.entries(wordCount).sort((a,b)=>b[1]-a[1])[0];
    focusInsight = topWord ? `"${topWord[0]}"` : `"${focusEntries[focusEntries.length-1]}"`;
  }

  let trendText = '';
  if (sessions.length >= 6) {
    const positiveMap = { Alive: 2, Calm: 1, Okay: 0, Restless: -0.5, Tired: -1, Heavy: -2 };
    const firstHalf = sessions.slice(0, Math.floor(sessions.length/2));
    const secondHalf = sessions.slice(Math.floor(sessions.length/2));
    const avg = arr => arr.reduce((s,x) => s + (positiveMap[x.mood]||0), 0) / arr.length;
    const diff = avg(secondHalf) - avg(firstHalf);
    if (diff > 0.3) trendText = 'Trending lighter â†‘';
    else if (diff < -0.3) trendText = 'Trending heavier â†“';
    else trendText = 'Holding steady â†’';
  }

  const maxMood = Math.max(...Object.values(moodCounts));

  insights.innerHTML = `
    <div class="insights-grid">
      <div class="insight-card highlight">
        <p class="insight-label">Most present mood</p>
        <p class="insight-value">${moodIcons[dominantMood[0]]} ${dominantMood[0]}</p>
        <p class="insight-sub">${dominantMood[1]} of ${sessions.length} check-ins</p>
      </div>
      <div class="insight-card">
        <p class="insight-label">Avg intensity</p>
        <p class="insight-value">${avgIntensity}<span style="font-size:14px;color:var(--text-muted)">/10</span></p>
        <p class="insight-sub">${avgIntensity >= 7 ? 'Running high' : avgIntensity >= 4 ? 'Moderate load' : 'Quiet energy'}</p>
      </div>
      <div class="insight-card">
        <p class="insight-label">Your rhythm</p>
        <p class="insight-value" style="font-size:18px;">${cycleText}</p>
        ${trendText ? `<p class="insight-sub">${trendText}</p>` : ''}
      </div>
      <div class="insight-card">
        <p class="insight-label">Focus theme</p>
        <p class="insight-value" style="font-size:18px; font-style:italic;">${focusInsight}</p>
        <p class="insight-sub">From your entries</p>
      </div>
      <div class="insight-card full">
        <p class="insight-label">Mood distribution</p>
        ${moodOrder.filter(m => moodCounts[m]).map(m => `
          <div class="mood-bar-row">
            <span class="mood-bar-label">${moodIcons[m]} ${m}</span>
            <div class="mood-bar-track">
              <div class="mood-bar-fill" style="width:${(moodCounts[m]/maxMood*100)}%"></div>
            </div>
            <span class="mood-bar-count">${moodCounts[m]}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  // â”€â”€ Full log â”€â”€
  const moodIconsMap = { Heavy:'ðŸŒ§', Tired:'ðŸŒ«', Restless:'âš¡', Okay:'ðŸŒ¤', Calm:'ðŸŒŠ', Alive:'âœ¨' };
  const reversed = [...sessions].reverse();
  list.innerHTML = reversed.map(s => {
    const d = new Date(s.date);
    const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const icon = moodIconsMap[s.mood] || 'â—‹';
    return `
      <div class="history-entry">
        <p class="history-date">${dateStr}  Â·  ${timeStr}</p>
        <p class="history-mood">${icon} ${s.mood} Â· ${s.intensity}/10</p>
        ${s.focus ? `<p class="history-focus">"${s.focus}"</p>` : ''}
        ${s.feeling ? `<p class="history-feeling">${s.feeling.substring(0, 140)}${s.feeling.length > 140 ? '...' : ''}</p>` : ''}
      </div>
    `;
  }).join('');

  // Trigger scroll reveal after render
  setTimeout(() => initScrollReveal(), 100);
}

// â”€â”€ SCROLL REVEAL â”€â”€
function initScrollReveal() {
  const sections = document.querySelectorAll('#screen-history .reveal-section');
  if (!sections.length) return;

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, {
    root: document.getElementById('screen-history'),
    threshold: 0.08,
    rootMargin: '0px 0px -40px 0px'
  });

  sections.forEach((s, i) => {
    s.style.transitionDelay = `${i * 0.1}s`;
    observer.observe(s);
  });
}

// â”€â”€ EXPORT JSON â”€â”€
function exportJSON() {
  const data = {
    exported: new Date().toISOString(),
    app: 'Rewind',
    version: '1.2.0',
    totalSessions: sessions.length,
    sessions: sessions
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rewind-export-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('JSON downloaded');
}

// â”€â”€ EXPORT PDF (as printable HTML) â”€â”€
function exportPDF() {
  const moodIcons = { Heavy:'ðŸŒ§', Tired:'ðŸŒ«', Restless:'âš¡', Okay:'ðŸŒ¤', Calm:'ðŸŒŠ', Alive:'âœ¨' };
  const rows = [...sessions].reverse().map(s => {
    const d = new Date(s.date);
    const dateStr = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const icon = moodIcons[s.mood] || '';
    return `
      <div style="border:1px solid #e0d5cd; border-radius:10px; padding:18px 22px; margin-bottom:14px; page-break-inside:avoid;">
        <p style="font-size:11px; color:#9a8878; letter-spacing:1px; margin-bottom:8px; text-transform:uppercase;">${dateStr} Â· ${timeStr}</p>
        <p style="font-size:18px; color:#2c2520; margin-bottom:6px;">${icon} ${s.mood} Â· ${s.intensity}/10</p>
        ${s.focus ? `<p style="font-family:Georgia; font-size:16px; color:#8b6f5e; font-style:italic; margin-bottom:6px;">"${s.focus}"</p>` : ''}
        ${s.feeling ? `<p style="font-size:14px; color:#5a4e45; line-height:1.6;">${s.feeling}</p>` : ''}
      </div>
    `;
  }).join('');

  const moodCounts = {};
  sessions.forEach(s => moodCounts[s.mood] = (moodCounts[s.mood]||0)+1);
  const dominant = Object.entries(moodCounts).sort((a,b)=>b[1]-a[1])[0];

  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rewind â€” My Journal</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 680px; margin: 0 auto; padding: 40px 24px; background: #faf7f4; color: #2c2520; }
  h1 { font-family: Georgia; font-weight: 300; font-size: 42px; color: #8b6f5e; letter-spacing: 6px; margin-bottom: 4px; }
  .meta { font-size: 13px; color: #9a8878; margin-bottom: 8px; }
  .summary { background: #f0e8e0; border-radius: 10px; padding: 16px 20px; margin: 24px 0 32px; }
  .summary p { font-size: 14px; color: #5a4e45; margin-bottom: 4px; }
  @media print { body { background: white; } }
</style>
</head>
<body>
  <h1>REWIND</h1>
  <p class="meta">Exported ${new Date().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'})}</p>
  <div class="summary">
    <p><strong>${sessions.length}</strong> check-ins recorded</p>
    <p>Most present mood: <strong>${dominant ? dominant[0] : 'â€”'}</strong></p>
    <p>First entry: ${new Date(sessions[0]?.date).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}</p>
  </div>
  ${rows}
  <p style="text-align:center; font-family:Georgia; font-style:italic; color:#9a8878; margin-top:40px; font-size:14px;">â€” return to yourself â€”</p>
</body>
</html>`;

  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const win = window.open(url, '_blank');
  if (win) {
    win.onload = () => { win.print(); };
  }
  showToast('PDF ready â€” print to save');
}

// â”€â”€ TOAST â”€â”€
function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.className = 'toast';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2800);
}

// â”€â”€ UPDATE CARD â”€â”€
function showUpdateCard(update) {
  const overlay = document.getElementById('update-overlay');
  const inner = document.getElementById('update-card-inner');
  document.getElementById('update-message').textContent = update.message;
  document.getElementById('update-body').textContent = update.body;
  overlay.style.display = 'flex';
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      inner.style.opacity = '1';
      inner.style.transform = 'translateY(0)';
    });
  });
}

function dismissUpdate() {
  const overlay = document.getElementById('update-overlay');
  const inner = document.getElementById('update-card-inner');
  inner.style.opacity = '0';
  inner.style.transform = 'translateY(-12px)';
  setTimeout(() => {
    overlay.style.display = 'none';
    localStorage.setItem('rewind_seen_version', REWIND_VERSION);
    // Show context hints after dismissing
    const update = UPDATES[REWIND_VERSION];
    if (update && update.newElements) {
      showContextHints(update.newElements);
    }
  }, 500);
}

// â”€â”€ CONTEXT HINTS â”€â”€
function showContextHints(elements) {
  const seenHints = JSON.parse(localStorage.getItem('rewind_seen_hints') || '[]');
  elements.forEach((el, i) => {
    if (seenHints.includes(el.selector)) return;
    setTimeout(() => {
      const target = document.querySelector(el.selector);
      if (!target) return;
      // Add pulse glow
      target.classList.add('new-pulse');
      // Show floating hint
      showFloatingHint(target, el.hint);
      // Mark as seen after interaction
      const markSeen = () => {
        target.classList.remove('new-pulse');
        seenHints.push(el.selector);
        localStorage.setItem('rewind_seen_hints', JSON.stringify(seenHints));
        target.removeEventListener('click', markSeen);
        target.removeEventListener('touchstart', markSeen);
      };
      target.addEventListener('click', markSeen);
      target.addEventListener('touchstart', markSeen);
    }, i * 600);
  });
}

function showFloatingHint(target, text) {
  const hint = document.getElementById('context-hint');
  const inner = document.getElementById('context-hint-inner');
  const rect = target.getBoundingClientRect();
  inner.textContent = text;
  hint.style.display = 'block';
  hint.style.left = '50%';
  hint.style.top = (rect.top - 44) + 'px';
  hint.style.transform = 'translateX(-50%)';
  requestAnimationFrame(() => {
    requestAnimationFrame(() => { inner.style.opacity = '1'; });
  });
  setTimeout(() => {
    inner.style.opacity = '0';
    setTimeout(() => { hint.style.display = 'none'; }, 400);
  }, 3000);
}

// â”€â”€ RECENT ENTRIES ON WELCOME â”€â”€
function renderRecentEntries() {
  if (sessions.length === 0) return;

  const moodIcons = { Heavy:'ðŸŒ§', Tired:'ðŸŒ«', Restless:'âš¡', Okay:'ðŸŒ¤', Calm:'ðŸŒŠ', Alive:'âœ¨' };
  const recentSection = document.getElementById('recent-section');
  const recentEntries = document.getElementById('recent-entries');
  const scrollHint = document.getElementById('scroll-hint');

  recentSection.style.display = 'block';
  scrollHint.style.display = 'flex';

  // Show last 5 entries most recent first
  const recent = [...sessions].reverse().slice(0, 5);

  recentEntries.innerHTML = recent.map((s, i) => {
    const d = new Date(s.date);
    const now = new Date();
    const diffMs = now - d;
    const diffHrs = diffMs / (1000 * 60 * 60);
    const diffDays = diffMs / (1000 * 60 * 60 * 24);

    let timeLabel = '';
    if (diffHrs < 1) timeLabel = 'Just now';
    else if (diffHrs < 2) timeLabel = '1 hour ago';
    else if (diffHrs < 24) timeLabel = `${Math.floor(diffHrs)} hours ago`;
    else if (diffDays < 2) timeLabel = 'Yesterday';
    else timeLabel = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    const icon = moodIcons[s.mood] || 'â—‹';

    return `
      <div class="recent-entry">
        <p class="recent-entry-time">${timeLabel}</p>
        <div class="recent-entry-mood">
          <span class="recent-mood-icon">${icon}</span>
          <span class="recent-mood-name">${s.mood}</span>
          <span class="recent-mood-intensity">${s.intensity}/10</span>
        </div>
        ${s.feeling ? `<p class="recent-entry-feeling">${s.feeling}</p>` : ''}
        ${s.focus && s.focus !== 'Rest' ? `<p class="recent-entry-focus">Focus â€” <span>${s.focus}</span></p>` : ''}
        ${s.focus === 'Rest' ? `<p class="recent-entry-focus" style="color:var(--text-muted);">Rest was the focus</p>` : ''}
      </div>
    `;
  }).join('');

  // Show "see all" link if more than 5 entries
  if (sessions.length > 5) {
    recentEntries.innerHTML += `
      <div class="recent-divider" onclick="navigate('history')">
        + ${sessions.length - 5} more entries â€” see full pattern
      </div>
    `;
  }
}

// Start
init();
</script>
</body>
</html>
